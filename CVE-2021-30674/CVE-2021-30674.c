#include <stdio.h>
#include <stdint.h>
#include <mach/mach.h>
#include <CoreFoundation/CoreFoundation.h>

typedef mach_port_t io_object_t;
typedef io_object_t io_service_t;
typedef io_object_t io_connect_t;
extern const mach_port_t kIOMasterPortDefault;

kern_return_t IOObjectRelease(io_object_t object);
kern_return_t IOServiceOpen(io_service_t service, task_t task, uint32_t type, io_connect_t *client);
kern_return_t IOServiceClose(io_connect_t client);
io_service_t IOServiceGetMatchingService(mach_port_t master, CFDictionaryRef matching CF_RELEASES_ARGUMENT);
CFMutableDictionaryRef IOServiceMatching(const char *name) CF_RETURNS_RETAINED;
kern_return_t IOConnectCallMethod(io_connect_t client, uint32_t selector, const uint64_t *in, uint32_t inCnt, const void *inStruct, size_t inStructCnt, uint64_t *out, uint32_t *outCnt, void *outStruct, size_t *outStructCnt);


int main(){
    io_service_t service = IOServiceGetMatchingService(kIOMasterPortDefault, IOServiceMatching("AppleH6CamIn"));
    io_connect_t conn;
  	int type = 0;
    uint32_t ret = IOServiceOpen(service, mach_task_self(), type, &conn);
    if (ret != KERN_SUCCESS){
        printf("Can't open connection ret: 0x%X\n", ret);
        return -1;
    }
    uint64_t inputScalar[1] = {0x41414141};
    uint64_t outputScalar[1] = {0};
    uint32_t outputScalarCnt = 1;
    ret = IOConnectCallMethod(conn, 6, 0, 0, 0, 0, 0, 0, 0, 0);
    ret = IOConnectCallMethod(conn, 17, inputScalar, 1, NULL, 0, 
    	&outputScalar, &outputScalarCnt, NULL, NULL);
    if (ret == KERN_SUCCESS){
    	printf("Success\n");
    	printf("%X\n", outputScalar[0]);
    }
    else
    	printf("Failure: 0x%X\n", ret);
    return 0;
}